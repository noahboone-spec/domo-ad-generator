<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      --bg-primary: #1E1E1E;
      --bg-surface: #2A2A2A;
      --bg-elevated: #333333;
      --bg-hover: #444444;
      --text-primary: #E0E0E0;
      --text-secondary: #AAAAAA;
      --text-muted: #888888;
      --accent-blue: #99CCEE;
      --accent-orange: #FF9922;
      --accent-orange-hover: #FFAA44;
      --border: #444444;
      --border-active: #99CCEE;
      --success: #4CAF50;
      --error: #F44336;
      --warning: #FFB656;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 12px;
      padding: 20px;
      overflow-y: auto;
    }

    /* ── Header ── */
    .header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
    }
    .header-logo {
      width: 28px; height: 28px; flex-shrink: 0;
    }
    .header-logo svg { width: 28px; height: 28px; }
    .header-title {
      font-size: 16px; font-weight: 700; color: var(--accent-blue);
    }

    /* ── Section labels ── */
    .label {
      font-size: 10px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
    }
    .section {
      margin-bottom: 16px; padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }
    .section:last-child { border-bottom: none; padding-bottom: 0; }

    /* ── Inputs ── */
    input[type="text"], select {
      width: 100%; height: 34px; padding: 0 10px;
      background: var(--bg-surface); color: var(--text-primary);
      border: 1px solid var(--border); border-radius: 6px;
      font-family: inherit; font-size: 12px; outline: none;
    }
    input[type="text"]:focus, select:focus {
      border-color: var(--accent-blue);
    }
    input[type="text"]::placeholder { color: #666; }

    /* ── Small action buttons ── */
    .sm-btn {
      height: 34px; padding: 0 14px; border: none; border-radius: 6px;
      font-family: inherit; font-size: 11px; font-weight: 700;
      cursor: pointer; transition: all 0.15s; white-space: nowrap;
    }
    .sm-btn.accent {
      background: var(--accent-blue); color: #111;
    }
    .sm-btn.accent:hover { background: #b3d9f2; }
    .sm-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ── Inline row ── */
    .inline-row { display: flex; gap: 6px; }
    .inline-row .flex-1 { flex: 1; }

    /* ── Suggestion chips ── */
    .suggestions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; min-height: 0; }
    .chip {
      height: 24px; padding: 0 10px; display: inline-flex; align-items: center;
      background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px;
      font-size: 10px; color: var(--text-primary); cursor: pointer;
      transition: all 0.15s; max-width: 100%; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }
    .chip:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

    /* ── Theme grid ── */
    .theme-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
    }
    .theme-swatch {
      border: 2px solid var(--border); border-radius: 8px;
      cursor: pointer; overflow: hidden; transition: all 0.15s;
    }
    .theme-swatch.active { border-color: var(--border-active); }
    .theme-swatch:hover { border-color: var(--accent-blue); }
    .swatch-bar {
      height: 36px; display: flex; align-items: center; justify-content: center; gap: 5px;
      font-family: inherit; font-size: 13px; font-weight: 800;
    }
    .swatch-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .swatch-name {
      background: var(--bg-surface); text-align: center; padding: 5px 0;
      font-size: 10px; font-weight: 600; color: var(--text-primary);
      text-transform: capitalize;
    }

    /* ── Toggle buttons (channels, placement) ── */
    .options-row { display: flex; gap: 16px; }
    .options-col { flex: 1; }
    .toggle-group { display: flex; gap: 6px; }
    .toggle-btn {
      flex: 1; height: 34px; display: flex; align-items: center; justify-content: center;
      gap: 4px; border: 2px solid var(--border); border-radius: 6px;
      font-family: inherit; font-size: 11px; font-weight: 600;
      color: var(--text-muted); background: transparent; cursor: pointer;
      transition: all 0.15s;
    }
    .toggle-btn.active {
      border-color: var(--border-active); color: var(--accent-blue);
    }
    .toggle-btn:hover { border-color: var(--accent-blue); }
    .toggle-btn .count { font-size: 10px; color: var(--text-muted); font-weight: 400; }

    /* ── Illustration tabs ── */
    .illus-tabs { display: flex; gap: 4px; margin-bottom: 8px; }
    .illus-tab {
      height: 26px; padding: 0 10px; display: flex; align-items: center;
      border-radius: 4px; font-size: 11px; font-weight: 600;
      color: var(--text-muted); cursor: pointer; transition: all 0.15s;
      background: transparent;
    }
    .illus-tab.active { background: var(--bg-elevated); color: var(--text-primary); }
    .illus-panel { display: none; }
    .illus-panel.active { display: block; }
    .image-preview {
      width: 100%; max-height: 80px; object-fit: contain; border-radius: 4px;
      margin-top: 6px; background: var(--bg-surface);
    }

    /* ── Divider ── */
    .divider { height: 1px; background: var(--border); margin: 2px 0; }

    /* ── Generate button ── */
    .generate-btn {
      width: 100%; height: 42px; border: none; border-radius: 6px;
      background: var(--accent-orange); color: #fff;
      font-family: inherit; font-size: 14px; font-weight: 700;
      cursor: pointer; transition: background 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .generate-btn:hover { background: var(--accent-orange-hover); }
    .generate-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
    .generate-btn svg { width: 16px; height: 16px; }

    /* ── Status area ── */
    .status {
      background: var(--bg-surface); border-radius: 8px; padding: 12px;
      margin-top: 12px; display: none;
    }
    .status.visible { display: block; }
    .status-item {
      display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 11px;
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .status-dot.success { background: var(--success); }
    .status-dot.error { background: var(--error); }
    .status-dot.loading { background: var(--warning); }
    .progress-bar {
      width: 100%; height: 4px; background: var(--bg-elevated);
      border-radius: 2px; overflow: hidden; margin-top: 8px; display: none;
    }
    .progress-bar.visible { display: block; }
    .progress-fill {
      height: 100%; background: var(--accent-blue); border-radius: 2px;
      transition: width 0.3s ease; width: 0%;
    }
    .done-msg {
      color: var(--success); font-weight: 600; font-size: 13px; margin-top: 8px;
    }
    .error-box {
      color: var(--error); background: #2a1515; padding: 8px 12px;
      border-radius: 6px; margin-top: 8px; font-size: 11px;
    }
    .close-btn {
      background: var(--accent-blue); color: #111; border: none;
      padding: 8px 16px; border-radius: 6px; cursor: pointer;
      font-family: inherit; font-weight: 600; font-size: 12px; margin-top: 8px;
    }
    .close-btn:hover { background: #b3d9f2; }
  </style>
</head>
<body>
  <!-- ── Header ── -->
  <div class="header">
    <div class="header-logo"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="12" fill="#99CCEE"/><path fill-rule="evenodd" clip-rule="evenodd" d="M10 46.6H16.5C17.9 46.6 19.2 46.9 20.5 47.4C21.7 48 22.8 48.7 23.7 49.6C24.7 50.5 25.4 51.6 25.9 52.8C26.3 53.5 26.5 54.3 26.6 55.1C26.9 52.9 27.9 50.9 29.5 49.3C31.5 47.3 33.9 46.3 36.8 46.3C39.7 46.3 42.1 47.3 44.1 49.3C45.6 50.8 46.5 52.5 46.9 54.4V46.3L57 56L67.1 46.3V54.4C67.5 52.5 68.4 50.8 70 49.3C72 47.3 74.4 46.3 77.3 46.3C80.2 46.3 82.6 47.3 84.6 49.3C85.5 50.2 86.1 51.1 86.6 52.1V15H10V46.6ZM77.3 67.4C74.4 67.4 72 66.4 70 64.4C68.5 63 67.6 61.3 67.1 59.3V67.4H63.6V55.2L57 61.9L50.4 55.2V67.4H46.9V59.3C46.5 61.3 45.6 63 44.1 64.4C42.1 66.4 39.7 67.4 36.8 67.4C33.9 67.4 31.5 66.4 29.5 64.4C27.9 62.8 26.9 60.9 26.6 58.7C26.5 59.5 26.3 60.3 25.9 61C25.4 62.2 24.7 63.3 23.8 64.2C22.9 65.2 21.8 65.9 20.5 66.5C19.3 67 17.9 67.4 16.5 67.4H10V85H86.6V61.8C86.1 62.8 85.4 63.7 84.6 64.5C82.6 66.4 80.2 67.4 77.3 67.4ZM22.7 63C23.3 62.4 23.8 61.7 24.2 60.9C24.5 60 24.7 59.1 24.7 58.1C24.7 57.2 24.5 56.3 24.2 55.4C23.8 54.6 23.3 53.9 22.7 53.3C22 52.6 21.3 52.1 20.4 51.8C19.6 51.4 18.7 51.2 17.7 51.2H14.3V65H17.7C18.7 65 19.6 64.8 20.4 64.5C21.3 64.1 22 63.6 22.7 63ZM82.5 63.1C83.9 61.7 84.6 60 84.6 58C84.6 56.1 83.9 54.5 82.5 53.1C81.2 51.7 79.5 51 77.6 51C75.7 51 74.1 51.7 72.7 53.1C71.4 54.4 70.7 56.1 70.7 58C70.7 59.9 71.4 61.5 72.7 63.1C74.1 64.4 75.7 65.1 77.6 65.1C79.6 65.1 81.2 64.4 82.5 63.1ZM41.7 63.1C43.1 61.7 43.8 60 43.8 58C43.8 56.1 43.1 54.5 41.7 53.1C40.4 51.7 38.7 51 36.8 51C34.9 51 33.3 51.7 31.9 53.1C30.6 54.4 29.9 56.1 29.9 58C29.9 59.9 30.6 61.5 31.9 63.1C33.3 64.4 34.9 65.1 36.8 65.1C38.7 65.1 40.4 64.4 41.7 63.1Z" fill="white"/></svg></div>
    <div class="header-title">Domo Banner Generator</div>
  </div>

  <div id="form-area">
    <!-- ── 1. KG Copy ── -->
    <div class="section">
      <div class="label">Copy from Knowledge Graph</div>
      <div class="inline-row">
        <input type="text" id="kg-input" class="flex-1" placeholder="e.g. data integration, embedded analytics" />
        <button class="sm-btn accent" id="kg-btn" onclick="suggestCopy()">Suggest</button>
      </div>
      <div class="suggestions" id="headline-suggestions"></div>
      <div class="suggestions" id="cta-suggestions"></div>
    </div>

    <!-- ── 2. Headline & CTA ── -->
    <div class="section">
      <div class="label">Headline</div>
      <input type="text" id="headline" value="Connect all your data sources in minutes, not months" />
    </div>
    <div class="section">
      <div class="label">CTA Button</div>
      <input type="text" id="cta" value="LEARN MORE" />
    </div>

    <!-- ── 3. Theme ── -->
    <div class="section">
      <div class="label">Theme</div>
      <div class="theme-grid" id="theme-grid"></div>
    </div>

    <!-- ── 4. Channels & Placement ── -->
    <div class="section">
      <div class="options-row">
        <div class="options-col">
          <div class="label">Channels</div>
          <div class="toggle-group">
            <button class="toggle-btn active" data-channel="linkedin" onclick="toggleChannel(this)">
              LinkedIn <span class="count">(1)</span>
            </button>
            <button class="toggle-btn active" data-channel="gdn" onclick="toggleChannel(this)">
              GDN <span class="count">(11)</span>
            </button>
          </div>
        </div>
        <div class="options-col">
          <div class="label">Page</div>
          <div class="toggle-group">
            <button class="toggle-btn active" data-placement="current" onclick="togglePlacement(this)">Current</button>
            <button class="toggle-btn" data-placement="new" onclick="togglePlacement(this)">New</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ── 5. Illustration ── -->
    <div class="section">
      <div class="label">Illustration</div>
      <div class="illus-tabs">
        <div class="illus-tab active" data-tab="existing" onclick="switchIllusTab('existing')">Existing</div>
        <div class="illus-tab" data-tab="generate" onclick="switchIllusTab('generate')">AI Generate</div>
      </div>
      <div class="illus-panel active" id="panel-existing">
        <select id="illustration"></select>
      </div>
      <div class="illus-panel" id="panel-generate">
        <div class="inline-row">
          <input type="text" id="image-prompt" class="flex-1" placeholder="e.g. modern analytics dashboard with charts" />
          <button class="sm-btn accent" id="img-btn" onclick="generateImage()">Generate</button>
        </div>
        <div id="image-preview-area"></div>
      </div>
    </div>

    <!-- ── Divider ── -->
    <div class="divider"></div>

    <!-- ── 6. Generate Button ── -->
    <button class="generate-btn" id="generate-btn" onclick="generate()" style="margin-top: 12px;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
      Generate &amp; Import
    </button>
  </div>

  <div class="progress-bar" id="progress-bar"><div class="progress-fill" id="progress"></div></div>
  <div class="status" id="status"></div>
  <div id="message"></div>

  <script>
    var SERVER = "https://domo-banner-server-1053548598846.us-central1.run.app";
    var PLUGIN_KEY = "SJ62eSmoeSnjdwYOiymUdGpLSzH2GSQ6MogyYOcI9s8";
    var statusEl = document.getElementById("status");
    var progressBar = document.getElementById("progress-bar");
    var progressEl = document.getElementById("progress");
    var messageEl = document.getElementById("message");
    var genBtn = document.getElementById("generate-btn");

    var selectedTheme = "dark";
    var activeChannels = new Set(["linkedin", "gdn"]);
    var generatedImageBase64 = null;
    var useGeneratedImage = false;
    var useCurrentPage = true;

    // ── Safe DOM helpers ──
    function createStatusItem(dotClass, text) {
      var div = document.createElement("div");
      div.className = "status-item";
      var dot = document.createElement("span");
      dot.className = "status-dot " + dotClass;
      var span = document.createElement("span");
      span.textContent = text;
      div.appendChild(dot);
      div.appendChild(span);
      return div;
    }

    function clearElement(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    // ── Theme grid ──
    async function loadThemes() {
      var grid = document.getElementById("theme-grid");
      try {
        var res = await fetch(SERVER + "/api/themes", { headers: { "X-Plugin-Key": PLUGIN_KEY } });
        var themesData = await res.json();
        themesData.forEach(function(t) {
          var swatch = document.createElement("div");
          swatch.className = "theme-swatch" + (t.name === selectedTheme ? " active" : "");
          swatch.dataset.theme = t.name;
          swatch.onclick = function() { selectTheme(t.name); };

          var bar = document.createElement("div");
          bar.className = "swatch-bar";
          bar.style.background = t.bgColor;
          bar.style.color = t.headlineColor;
          bar.textContent = "Aa";

          var dot = document.createElement("span");
          dot.className = "swatch-dot";
          dot.style.background = t.ctaBgColor;
          bar.appendChild(dot);

          var name = document.createElement("div");
          name.className = "swatch-name";
          name.textContent = t.name;

          swatch.appendChild(bar);
          swatch.appendChild(name);
          grid.appendChild(swatch);
        });
      } catch (e) {
        ["dark", "light"].forEach(function(name) {
          var swatch = document.createElement("div");
          swatch.className = "theme-swatch" + (name === selectedTheme ? " active" : "");
          swatch.dataset.theme = name;
          swatch.textContent = name;
          swatch.onclick = function() { selectTheme(name); };
          grid.appendChild(swatch);
        });
      }
    }

    function selectTheme(name) {
      selectedTheme = name;
      document.querySelectorAll(".theme-swatch").forEach(function(el) {
        el.classList.toggle("active", el.dataset.theme === name);
      });
    }

    // ── Channels ──
    function toggleChannel(el) {
      var ch = el.dataset.channel;
      if (activeChannels.has(ch)) {
        activeChannels.delete(ch);
        el.classList.remove("active");
      } else {
        activeChannels.add(ch);
        el.classList.add("active");
      }
    }

    // ── Placement ──
    function togglePlacement(el) {
      var placement = el.dataset.placement;
      useCurrentPage = (placement === "current");
      document.querySelectorAll("[data-placement]").forEach(function(btn) {
        btn.classList.toggle("active", btn.dataset.placement === placement);
      });
    }

    // ── Illustrations ──
    async function loadIllustrations() {
      var selectEl = document.getElementById("illustration");
      try {
        var res = await fetch(SERVER + "/api/illustrations", { headers: { "X-Plugin-Key": PLUGIN_KEY } });
        var files = await res.json();
        files.forEach(function(f) {
          var opt = document.createElement("option");
          opt.value = f;
          opt.textContent = f;
          selectEl.appendChild(opt);
        });
      } catch (e) {
        var opt = document.createElement("option");
        opt.value = "illustration.png";
        opt.textContent = "illustration.png";
        selectEl.appendChild(opt);
      }
    }

    function switchIllusTab(tab) {
      document.querySelectorAll(".illus-tab").forEach(function(el) {
        el.classList.toggle("active", el.dataset.tab === tab);
      });
      document.getElementById("panel-existing").classList.toggle("active", tab === "existing");
      document.getElementById("panel-generate").classList.toggle("active", tab === "generate");
      useGeneratedImage = (tab === "generate" && generatedImageBase64 !== null);
    }

    // ── KG Copy Suggestions ──
    async function suggestCopy() {
      var input = document.getElementById("kg-input").value.trim();
      if (!input) return;

      var btn = document.getElementById("kg-btn");
      btn.disabled = true;
      btn.textContent = "\u21BB";

      try {
        var res = await fetch(SERVER + "/api/copy", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-Plugin-Key": PLUGIN_KEY },
          body: JSON.stringify({ product: input }),
        });
        var data = await res.json();
        if (data.error) throw new Error(data.error);

        var hlBox = document.getElementById("headline-suggestions");
        clearElement(hlBox);
        (data.headlines || []).forEach(function(h) {
          var chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = h;
          chip.title = h;
          chip.onclick = function() {
            document.getElementById("headline").value = h;
          };
          hlBox.appendChild(chip);
        });

        var ctaBox = document.getElementById("cta-suggestions");
        clearElement(ctaBox);
        (data.ctas || []).forEach(function(c) {
          var chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = c;
          chip.onclick = function() {
            document.getElementById("cta").value = c;
          };
          ctaBox.appendChild(chip);
        });
      } catch (err) {
        showError("KG error: " + err.message);
      }

      btn.disabled = false;
      btn.textContent = "Suggest";
    }

    // ── Gemini Image Generation ──
    async function generateImage() {
      var prompt = document.getElementById("image-prompt").value.trim();
      if (!prompt) return;

      var btn = document.getElementById("img-btn");
      btn.disabled = true;
      btn.textContent = "\u21BB";

      var previewArea = document.getElementById("image-preview-area");
      clearElement(previewArea);
      var loadingMsg = document.createElement("div");
      loadingMsg.style.cssText = "font-size:11px; color:var(--warning); padding:6px 0;";
      loadingMsg.textContent = "Generating image with Gemini... (10\u201330s)";
      previewArea.appendChild(loadingMsg);

      try {
        var res = await fetch(SERVER + "/api/generate-image", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-Plugin-Key": PLUGIN_KEY },
          body: JSON.stringify({ prompt: prompt }),
        });
        var data = await res.json();
        if (data.error) throw new Error(data.error);

        generatedImageBase64 = data.imageBase64;
        useGeneratedImage = true;

        clearElement(previewArea);
        var img = document.createElement("img");
        img.className = "image-preview";
        img.src = "data:" + (data.mimeType || "image/png") + ";base64," + data.imageBase64;
        img.alt = "Generated illustration";
        previewArea.appendChild(img);

        var info = document.createElement("div");
        info.style.cssText = "font-size:10px; color:var(--success); padding:4px 0;";
        info.textContent = "\u2713 Saved as " + data.filename + " \u2014 will be used for banners";
        previewArea.appendChild(info);
      } catch (err) {
        clearElement(previewArea);
        showError("Image generation failed: " + err.message);
      }

      btn.disabled = false;
      btn.textContent = "Generate";
    }

    // ── Messages from plugin code ──
    onmessage = function(event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === "progress") {
        var pct = Math.round((msg.done / msg.total) * 100);
        progressEl.style.width = pct + "%";
        statusEl.appendChild(createStatusItem("success", msg.slug + " \u2014 created"));
      }
      if (msg.type === "error") {
        statusEl.appendChild(createStatusItem("error", msg.slug + ": " + msg.message));
      }
      if (msg.type === "complete") {
        progressEl.style.width = "100%";
        clearElement(messageEl);
        var p = document.createElement("p");
        p.className = "done-msg";
        var pageDesc = msg.usedCurrentPage ? "current page" : "page \u201C" + msg.pageName + "\u201D";
        p.textContent = "\u2713 Done! Created " + msg.count + " banners on " + pageDesc;
        messageEl.appendChild(p);

        var closeBtn = document.createElement("button");
        closeBtn.className = "close-btn";
        closeBtn.textContent = "Close Plugin";
        closeBtn.onclick = function() {
          parent.postMessage({ pluginMessage: { type: "close" } }, "*");
        };
        messageEl.appendChild(closeBtn);

        genBtn.disabled = false;
        genBtn.textContent = "";
        var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.setAttribute("fill", "none");
        svg.setAttribute("stroke", "currentColor");
        svg.setAttribute("stroke-width", "2");
        svg.setAttribute("stroke-linecap", "round");
        svg.setAttribute("stroke-linejoin", "round");
        var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute("points", "13 2 3 14 12 14 11 22 21 10 12 10 13 2");
        svg.appendChild(polygon);
        genBtn.appendChild(svg);
        genBtn.appendChild(document.createTextNode(" Generate & Import"));
      }
    };

    function showError(text) {
      clearElement(messageEl);
      var div = document.createElement("div");
      div.className = "error-box";
      div.textContent = text;
      messageEl.appendChild(div);
    }

    // ── Generate & Import ──
    async function generate() {
      if (activeChannels.size === 0) { showError("Select at least one channel."); return; }
      var headline = document.getElementById("headline").value.trim();
      if (!headline) { showError("Enter a headline."); return; }

      genBtn.disabled = true;
      genBtn.textContent = "Generating...";
      clearElement(messageEl);
      clearElement(statusEl);
      statusEl.appendChild(createStatusItem("loading", "Generating SVGs on server..."));
      statusEl.classList.add("visible");
      progressBar.classList.add("visible");
      progressEl.style.width = "10%";

      try {
        var payload = {
          headline: headline,
          cta: document.getElementById("cta").value.trim() || "LEARN MORE",
          theme: selectedTheme,
          channels: Array.from(activeChannels),
          illustration: document.getElementById("illustration").value,
        };

        if (useGeneratedImage && generatedImageBase64) {
          payload.imageBase64 = generatedImageBase64;
        }

        var res = await fetch(SERVER + "/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-Plugin-Key": PLUGIN_KEY },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          var errData = await res.json();
          throw new Error(errData.error || "Server error");
        }

        var data = await res.json();
        progressEl.style.width = "50%";

        clearElement(statusEl);
        statusEl.appendChild(createStatusItem("success", "Generated " + data.banners.length + " banners"));
        statusEl.appendChild(createStatusItem("loading", "Creating layers in Figma..."));

        parent.postMessage({
          pluginMessage: {
            type: "create-banners",
            pageName: data.pageName,
            banners: data.banners,
            useCurrentPage: useCurrentPage,
          },
        }, "*");
      } catch (err) {
        clearElement(statusEl);
        statusEl.classList.remove("visible");
        progressBar.classList.remove("visible");
        showError("Generation failed: " + err.message);
        genBtn.disabled = false;
        genBtn.textContent = "";
        var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", "0 0 24 24");
        svg.setAttribute("fill", "none");
        svg.setAttribute("stroke", "currentColor");
        svg.setAttribute("stroke-width", "2");
        svg.setAttribute("stroke-linecap", "round");
        svg.setAttribute("stroke-linejoin", "round");
        var polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        polygon.setAttribute("points", "13 2 3 14 12 14 11 22 21 10 12 10 13 2");
        svg.appendChild(polygon);
        genBtn.appendChild(svg);
        genBtn.appendChild(document.createTextNode(" Generate & Import"));
      }
    }

    // ── Init ──
    loadThemes();
    loadIllustrations();
  </script>
</body>
</html>
